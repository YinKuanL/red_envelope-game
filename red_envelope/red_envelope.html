<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紅包彈珠台遊戲</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        let engine, world, render;
        let totalAmount = 0;
        let gameActive = false;
        let timer = 30;
        let interval;
        let spawnInterval;
        let redEnvelopes = []; // 儲存多個紅包
        let receivedEnvelopes = []; // 儲存接到的紅包資料
        let paddle;
        let gravityScale = 0.3;
        const redEnvelopeTexture = "/red_envelope.jpg";

        // 紅包來源名稱列表
        const redEnvelopeSources = ["大姨丈", "表哥", "小姨", "叔叔", "阿公", "阿嬤", "堂姐", "舅舅"];

        function startGame() {
            if (gameActive) return;
            gameActive = true;
            totalAmount = 0;
            timer = 30;
            gravityScale = 0.3;
            receivedEnvelopes = [];
            document.getElementById('total-amount').innerText = "累計收到: 0 元";
            document.getElementById('timer').innerText = `剩餘時間: ${timer} 秒`;
            document.getElementById('end-message').style.display = 'none';
            document.getElementById('red-envelope-log').innerHTML = "";
            interval = setInterval(updateTimer, 1000);

            // 每隔 1 秒生成一個紅包
            spawnInterval = setInterval(() => {
                if (gameActive) spawnRedEnvelope();
            }, 1000);
        }

        function updateTimer() {
            timer--;
            document.getElementById('timer').innerText = `剩餘時間: ${timer} 秒`;
            gravityScale += 0.02; // 每秒增加重力，加快掉落速度
            engine.world.gravity.y = gravityScale;

            if (timer <= 0) {
                endGame();
            }
        }

        function endGame() {
            clearInterval(interval);
            clearInterval(spawnInterval);
            gameActive = false;

            // 顯示結束訊息和紅包列表
            const endMessage = document.getElementById('end-message');
            let logList = receivedEnvelopes.map(e => `<li>${e.source} 給了 ${e.amount} 元</li>`).join('');
            endMessage.innerHTML = `
                <h2>新年快樂！</h2>
                <p>這是你今年的紅包總額：<strong>${totalAmount} 元</strong></p>
                <ul>${logList}</ul>
                <button class="button" onclick="startGame()">再玩一次</button>
            `;
            endMessage.style.display = 'block';
        }

        function spawnRedEnvelope() {
            const randomX = Math.random() * 400 + 50; // 隨機 x 座標
            const redEnvelope = Matter.Bodies.circle(randomX, 50, 15, { // 縮小紅包尺寸
                restitution: 0.8,
                frictionAir: 0.02,
                density: 0.001,
                render: {
                    sprite: { texture: redEnvelopeTexture, xScale: 0.3, yScale: 0.3 } // 縮放比例
                }
            });

            // 隨機選取紅包來源和金額
            const source = redEnvelopeSources[Math.floor(Math.random() * redEnvelopeSources.length)];
            const amount = (Math.floor(Math.random() * 10) + 1) * 100; // 100 至 1000 的隨機金額
            redEnvelope.customData = { source, amount }; // 將來源和金額存入紅包的自訂屬性

            redEnvelopes.push(redEnvelope);
            Matter.World.add(world, redEnvelope);
        }

        function setupPhysics() {
            engine = Matter.Engine.create();
            world = engine.world;
            engine.world.gravity.y = gravityScale;

            render = Matter.Render.create({
                element: document.getElementById("game-canvas"),
                engine: engine,
                options: {
                    width: 500,
                    height: 500,
                    wireframes: false,
                    background: "#f2d16b"
                }
            });

            const ground = Matter.Bodies.rectangle(250, 480, 500, 20, { isStatic: true });
            const walls = [
                Matter.Bodies.rectangle(0, 250, 20, 500, { isStatic: true }),
                Matter.Bodies.rectangle(500, 250, 20, 500, { isStatic: true })
            ];

            // 縮小的擋板
            paddle = Matter.Bodies.rectangle(250, 450, 100, 15, {
                isStatic: true,
                render: { fillStyle: "red" }
            });

            Matter.World.add(world, [ground, paddle, ...walls]);
            Matter.Engine.run(engine);
            Matter.Render.run(render);
        }

        function checkCollisions() {
            Matter.Events.on(engine, "collisionStart", function(event) {
                event.pairs.forEach(pair => {
                    redEnvelopes.forEach((redEnvelope, index) => {
                        if ((pair.bodyA === redEnvelope && pair.bodyB === paddle) || (pair.bodyB === redEnvelope && pair.bodyA === paddle)) {
                            const { source, amount } = redEnvelope.customData; // 取得來源和金額
                            totalAmount += amount;

                            // 記錄紅包資訊
                            receivedEnvelopes.push({ source, amount });

                            // 動態顯示紅包紀錄
                            const logDiv = document.getElementById('red-envelope-log');
                            const logItem = document.createElement('div');
                            logItem.textContent = `${source} 給了 ${amount} 元`;
                            logDiv.appendChild(logItem);

                            document.getElementById('total-amount').innerText = `累計收到: ${totalAmount} 元`;
                            Matter.World.remove(world, redEnvelope);
                            redEnvelopes.splice(index, 1); // 從陣列中移除紅包
                        }
                    });
                });
            });
        }

        function removeOffscreenEnvelopes() {
            setInterval(() => {
                redEnvelopes = redEnvelopes.filter(redEnvelope => {
                    if (redEnvelope.position.y > 500) { // 超出畫面高度
                        Matter.World.remove(world, redEnvelope);
                        return false;
                    }
                    return true;
                });
            }, 100);
        }

        function enablePaddleControl() {
            document.addEventListener("keydown", function(event) {
                if (event.key === "ArrowLeft") {
                    Matter.Body.setPosition(paddle, { x: Math.max(paddle.position.x - 30, 50), y: 450 });
                } else if (event.key === "ArrowRight") {
                    Matter.Body.setPosition(paddle, { x: Math.min(paddle.position.x + 30, 450), y: 450 });
                }
            });
        }

        window.onload = function() {
            setupPhysics();
            checkCollisions();
            enablePaddleControl();
            removeOffscreenEnvelopes(); // 定期移除超出畫面的紅包
        };
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/golden-fabric.png');
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .button {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .game-container {
            position: relative;
            width: 500px;
            height: 500px;
            margin: auto;
            border: 2px solid #ff4500;
            background: #f2d16b;
        }
        .log-container {
            width: 200px;
            margin-left: 20px;
            background: #fff7e6;
            border: 1px solid #ff4500;
            padding: 10px;
            overflow-y: auto;
            max-height: 500px;
        }
        #end-message {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding-top: 150px;
        }
        .amount-display {
            margin: 10px 0;
        }
        .main-container {
            display: flex;
        }
    </style>
</head>
<body>
<h1>紅包彈珠台遊戲</h1>
<button class="button" onclick="startGame()">開始遊戲</button>
<div id="timer" class="amount-display">按下開始遊戲</div>
<div class="main-container">
    <div class="game-container" id="game-canvas">
        <div id="end-message"></div>
    </div>
    <div class="log-container" id="red-envelope-log"></div>
</div>
<div class="amount-display">
    <p id="total-amount">累計收到: 0 元</p>
</div>
</body>
</html>
